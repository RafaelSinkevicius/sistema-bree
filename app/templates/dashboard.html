{% extends "base.html" %}

{% block title %}Dashboard | Bree{% endblock %}

{% block content %}
<div style="margin-bottom: 2rem; display: flex; justify-content: space-between; align-items: center;">
    <div>
        <h1 style="font-size: 2rem; font-weight: 800; color: var(--primary);">VisÃ£o Geral</h1>
        <p style="color: var(--text-muted);">Acompanhamento em tempo real da carteira.</p>
    </div>
    <div style="text-align: right;">
        <span
            style="font-size: 0.9rem; background: white; padding: 0.5rem 1rem; border-radius: 20px; box-shadow: var(--shadow-sm); font-weight: 600;">
            Total Contratos: {{ total }}
        </span>
    </div>
</div>

<!-- Grid System for Status Cards -->
<div
    style="display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">

    <!-- Ativos (Em dia + Pago) -->
    <div class="card" style="border-left: 5px solid var(--secondary);">
        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.5rem;">
            <div>
                <div style="font-size: 0.85rem; color: var(--text-muted); font-weight: 600; text-transform: uppercase;">
                    Ativos</div>
                <div style="font-size: 2rem; font-weight: 800; color: var(--secondary);">{{ status_counts['Ativos'] }}
                </div>
            </div>
            <div style="background: var(--secondary-light); padding: 8px; border-radius: 8px;">
                <i data-lucide="check-circle" style="color: var(--secondary);"></i>
            </div>
        </div>
        <div style="font-size: 0.85rem; color: var(--text-muted);">Contratos em dia ou pagos</div>
    </div>

    <!-- Em Atraso -->
    <a href="{{ url_for('painel_cobranca', status='Em atraso') }}" class="card"
        style="border-left: 5px solid var(--warning); text-decoration: none; display: block; transition: transform 0.2s;">
        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.5rem;">
            <div>
                <div style="font-size: 0.85rem; color: var(--text-muted); font-weight: 600; text-transform: uppercase;">
                    Em Atraso</div>
                <div style="font-size: 2rem; font-weight: 800; color: var(--warning);">{{ status_counts['Atrasados'] }}
                </div>
            </div>
            <div style="background: var(--warning-light); padding: 8px; border-radius: 8px;">
                <i data-lucide="clock" style="color: #856404;"></i>
            </div>
        </div>
        <div style="font-size: 0.85rem; color: var(--text-muted);">AÃ§Ã£o necessÃ¡ria</div>
    </a>

    <!-- Cancelados InadimplÃªncia -->
    <div class="card" style="border-left: 5px solid var(--danger);">
        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.5rem;">
            <div>
                <div style="font-size: 0.85rem; color: var(--text-muted); font-weight: 600; text-transform: uppercase;">
                    Cancelados (Inad.)</div>
                <!-- FIXED KEY HERE -->
                <div style="font-size: 2rem; font-weight: 800; color: var(--danger);">{{
                    status_counts['Cancelados_Inad'] }}</div>
            </div>
            <div style="background: var(--danger-light); padding: 8px; border-radius: 8px;">
                <i data-lucide="x-circle" style="color: var(--danger);"></i>
            </div>
        </div>
        <div style="font-size: 0.85rem; color: var(--text-muted);">Perdidos por falta de pagt</div>
    </div>
</div>

<!-- Bottom Two Cards Centered -->
<div
    style="display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 300px)); gap: 1.5rem; justify-content: center; margin-bottom: 3rem;">

    <!-- Cancelados por Regra -->
    <div class="card" style="border-left: 5px solid #6c757d;">
        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.5rem;">
            <div>
                <div style="font-size: 0.85rem; color: var(--text-muted); font-weight: 600; text-transform: uppercase;">
                    Cancelados (Regra)</div>
                <!-- FIXED KEY HERE -->
                <div style="font-size: 2rem; font-weight: 800; color: #6c757d;">{{ status_counts['Cancelados_Regra'] }}
                </div>
            </div>
            <div style="background: #e9ecef; padding: 8px; border-radius: 8px;">
                <i data-lucide="file-x-2" style="color: #6c757d;"></i>
            </div>
        </div>
        <div style="font-size: 0.85rem; color: var(--text-muted);">Cancelados por norma interna</div>
    </div>

</div>

<!-- GrÃ¡fico -->
<div class="card" style="margin-bottom: 3rem;">
    <h3 style="margin-bottom: 1.5rem; font-weight: 700;">DistribuiÃ§Ã£o da Carteira</h3>
    <div style="height: 300px; display: flex; justify-content: center;">
        <canvas id="statusChart"></canvas>
    </div>
</div>

<!-- AÃ§Ãµes RÃ¡pidas -->
<div class="card">
    <h2 style="margin-bottom: 1rem; font-weight: 700;">AÃ§Ãµes RÃ¡pidas</h2>
    <div style="display: flex; gap: 0.75rem; flex-wrap: nowrap; align-items: center;">

        <a href="{{ url_for('listar_contratos') }}" class="btn btn-primary">
            <i data-lucide="search"></i> Buscar Contrato
        </a>

        {% if session.get("usuario_tipo") == "admin" %}

        <a href="{{ url_for('importar_contratos_view') }}" class="btn btn-outline">
            <i data-lucide="upload"></i> Importar Contratos
        </a>

        <a href="{{ url_for('sobrepor_status_view') }}" class="btn btn-outline"
            style="color: var(--danger); border-color: var(--danger);">
            <i data-lucide="refresh-cw"></i> Sobrepor Status
        </a>

        <button onclick="openExportModal()" class="btn btn-outline"
            style="color: var(--secondary); border-color: var(--secondary);">
            <i data-lucide="download"></i> Exportar Base
        </button>
        {% endif %}
    </div>
</div>

<!-- STYLES PARA MODAL -->
<style>
    /* Simple Checkbox Animation */
    .export-option {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.75rem 1rem;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.15s ease;
    }

    .export-option:hover {
        opacity: 0.85;
    }

    .export-option input[type="checkbox"] {
        width: 18px;
        height: 18px;
        cursor: pointer;
        accent-color: var(--primary);
    }

    /* Loading Modal */
    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.7);
        z-index: 2000;
        display: none;
        justify-content: center;
        align-items: center;
    }

    .loading-content {
        background: white;
        border-radius: 16px;
        padding: 2rem;
        text-align: center;
        max-width: 380px;
        width: 90%;
    }

    .spinner {
        width: 45px;
        height: 45px;
        border: 4px solid #e5e7eb;
        border-top: 4px solid var(--primary);
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
        margin: 0 auto 1rem;
    }

    @keyframes spin {
        0% {
            transform: rotate(0deg);
        }

        100% {
            transform: rotate(360deg);
        }
    }

    .progress-bar-container {
        height: 10px;
        background: #e5e7eb;
        border-radius: 5px;
        overflow: hidden;
        margin: 1rem 0;
    }

    .progress-bar-fill {
        height: 100%;
        background: linear-gradient(90deg, var(--primary), var(--secondary));
        width: 0%;
        transition: width 0.2s ease;
    }

    .btn-cancel {
        background: none;
        border: 1px solid #ddd;
        padding: 0.5rem 1.5rem;
        border-radius: 6px;
        cursor: pointer;
        color: #666;
        margin-top: 0.5rem;
        transition: all 0.2s;
    }

    .btn-cancel:hover {
        background: #f3f4f6;
        color: #333;
    }
</style>

<!-- MODAL EXPORTAÃ‡ÃƒO -->
<div id="exportModal"
    style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
    <div
        style="background: white; border-radius: 12px; padding: 1.5rem; max-width: 420px; width: 90%; box-shadow: 0 20px 50px rgba(0,0,0,0.25);">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
            <h3 style="font-weight: 700; margin: 0;">ðŸ“Š Exportar Base</h3>
            <button onclick="closeExportModal()"
                style="background: none; border: none; cursor: pointer; font-size: 1.5rem; color: #666;">&times;</button>
        </div>

        <p style="color: var(--text-muted); margin-bottom: 1rem; font-size: 0.9rem;">Selecione quais contratos
            exportar:</p>

        <div style="display: flex; flex-direction: column; gap: 0.4rem;">
            <label class="export-option" style="background: #e0f2fe; border: 2px solid var(--primary);">
                <input type="checkbox" id="chk-all" onchange="toggleExportAll()" checked>
                <span style="font-weight: 600;">Base Completa (Todos)</span>
            </label>

            <div style="border-top: 1px solid #e5e7eb; margin: 0.3rem 0;"></div>

            <label class="export-option" style="background: #f0fdf4;">
                <input type="checkbox" class="chk-item" value="Em dia" data-name="ativos" onchange="checkManual()">
                <span>Ativos (Em dia)</span>
            </label>

            <label class="export-option" style="background: #fffbeb;">
                <input type="checkbox" class="chk-item" value="Em atraso" data-name="atrasados"
                    onchange="checkManual()">
                <span>Atrasados</span>
            </label>

            <label class="export-option" style="background: #fef2f2;">
                <input type="checkbox" class="chk-item" value="Cancelado por InadimplÃªncia" data-name="cancelados_inad"
                    onchange="checkManual()">
                <span>Cancelados (InadimplÃªncia)</span>
            </label>

            <label class="export-option" style="background: #f3f4f6;">
                <input type="checkbox" class="chk-item" value="Cancelado por Regra" data-name="cancelados_regra"
                    onchange="checkManual()">
                <span>Cancelados (Regra)</span>
            </label>
        </div>

        <button onclick="iniciarExportacao()" class="btn btn-primary"
            style="width: 100%; margin-top: 1rem; padding: 0.85rem;">
            <i data-lucide="download"></i> Exportar
        </button>
    </div>
</div>

<!-- MODAL LOADING -->
<div id="loadingModal" class="loading-overlay">
    <div class="loading-content">
        <div class="spinner"></div>
        <h4 id="loadingTitle" style="margin: 0 0 0.5rem; font-weight: 700;">Gerando Planilha...</h4>
        <p id="loadingText" style="color: var(--text-muted); margin: 0 0 1rem; font-size: 0.9rem;">Aguarde enquanto
            processamos os dados</p>
        <button id="btnCancel" class="btn-cancel" onclick="cancelarDownload()">Cancelar</button>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Chart
    const ctx = document.getElementById('statusChart');
    new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['Ativos', 'Atrasados', 'Cancelados Inad.', 'Cancelados Regra'],
            datasets: [{
                data: [
                    {{ status_counts['Ativos'] }},
            {{ status_counts['Atrasados'] }},
                    {{ status_counts['Cancelados_Inad'] }},
        {{ status_counts['Cancelados_Regra'] }}
                ],
        backgroundColor: ['#008f5d', '#bf8700', '#cf222e', '#6e7781'],
        borderWidth: 0
            }]
        },
        options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { position: 'right' } }
    }
    });

    // Modal Functions
    let abortController = null;

    function openExportModal() {
        document.getElementById('exportModal').style.display = 'flex';
        lucide.createIcons();
    }

    function closeExportModal() {
        document.getElementById('exportModal').style.display = 'none';
    }

    function toggleExportAll() {
        const isAll = document.getElementById('chk-all').checked;
        if (isAll) {
            document.querySelectorAll('.chk-item').forEach(chk => chk.checked = false);
        }
    }

    function checkManual() {
        const anyChecked = document.querySelectorAll('.chk-item:checked').length > 0;
        document.getElementById('chk-all').checked = !anyChecked;
    }

    function getExportFilename() {
        if (document.getElementById('chk-all').checked) return 'base_completa';
        const names = Array.from(document.querySelectorAll('.chk-item:checked')).map(c => c.dataset.name);
        return names.length ? 'base_' + names.join('_') : 'base_completa';
    }

    function formatBytes(bytes) {
        if (bytes === 0) return '0 B';
        const k = 1024;
        const sizes = ['B', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
    }

    function cancelarDownload() {
        if (abortController) {
            abortController.abort();
            abortController = null;
        }
        document.getElementById('loadingModal').style.display = 'none';
    }

    async function iniciarExportacao() {
        const loadingModal = document.getElementById('loadingModal');
        const loadingText = document.getElementById('loadingText');
        const loadingTitle = document.getElementById('loadingTitle');

        let statusParam = "TODOS";
        if (!document.getElementById('chk-all').checked) {
            const vals = Array.from(document.querySelectorAll('.chk-item:checked')).map(c => c.value);
            if (vals.length) statusParam = vals.join(',');
        }

        const filename = getExportFilename();

        closeExportModal();
        loadingModal.style.display = 'flex';
        loadingTitle.innerText = 'Gerando Planilha...';
        loadingText.innerText = 'Consultando banco de dados...';

        abortController = new AbortController();

        try {
            loadingText.innerText = 'Processando contratos...';

            const response = await fetch(`{{ url_for('exportar_base_completa') }}?status=${encodeURIComponent(statusParam)}`, {
                signal: abortController.signal
            });

            if (!response.ok) throw new Error('Erro HTTP ' + response.status);

            loadingText.innerText = 'Baixando arquivo...';

            const blob = await response.blob();
            const url = URL.createObjectURL(blob);
            const today = new Date().toISOString().split('T')[0];

            loadingTitle.innerText = 'ConcluÃ­do!';
            loadingText.innerText = 'Iniciando download...';

            const a = document.createElement('a');
            a.href = url;
            a.download = `${filename}_${today}.xlsx`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            setTimeout(() => loadingModal.style.display = 'none', 300);

        } catch (err) {
            if (err.name === 'AbortError') {
                console.log('Download cancelado');
            } else {
                console.error(err);
                loadingModal.style.display = 'none';
                alert('Erro: ' + err.message);
            }
        } finally {
            abortController = null;
        }
    }
</script>
{% endblock %}